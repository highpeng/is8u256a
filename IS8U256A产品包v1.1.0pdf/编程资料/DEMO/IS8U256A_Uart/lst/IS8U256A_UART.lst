C51 COMPILER V9.02   IS8U256A_UART                                                         12/11/2014 10:39:21 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE IS8U256A_UART
OBJECT MODULE PLACED IN .\obj\IS8U256A_UART.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\IS8U256A_UART.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\lst\IS8U256A_UA
                    -RT.lst) OBJECT(.\obj\IS8U256A_UART.obj)

line level    source

   1          /*********************************************************************
   2          *               Copyright(C)2012北京华大信安科技有限公司
   3          *                       All Rights Reserved      
   4          *
   5          * 文件名称：    XA1302_UART.c
   6          * 作    者：    李宪法
   7          * 版    本：    V1.0.0
   8          * 日    期：    2013-11
   9          * 功能描述：    
  10          * 功能列表：    
  11          *
  12          * 历史记录：
  13          * 1.  日期：    
  14          *         版本：
  15          *         作者：
  16          * 修改内容：
  17          *
  18          *********************************************************************/
  19          
  20          /*Includes----------------------------------------------------------*/
  21          #include "..\inc\IS8U256X.h"
  22          
  23          /*Private typedef---------------------------------------------------*/
  24          /*Private define----------------------------------------------------*/
  25          #define UART_CLK                        48000000
  26          
  27          /*Private macro-----------------------------------------------------*/
  28          /*Private variables-------------------------------------------------*/
  29          /*Private function prototypes---------------------------------------*/
  30          /*Private functions-------------------------------------------------*/
  31          
  32          /********************************************************************
  33           * Function Name        :GCD
  34           * Description          :
  35           * Argument             :
  36           * Return               :
  37          *********************************************************************/
  38          static unsigned long GCD(unsigned long X1 , unsigned long X2)
  39          {
  40   1              unsigned long max=0x0;
  41   1              unsigned long min=0x0;
  42   1              unsigned long X,Y,R;
  43   1      
  44   1              max = (X1>X2)?X1:X2;
  45   1              min = (X1>X2)?X2:X1;
  46   1              X = max;
  47   1              Y = min;
  48   1      
  49   1              while(0x0!=Y)
  50   1              {
  51   2                      R = X%Y;
  52   2                      X = Y;
  53   2                      Y = R;
  54   2              }
C51 COMPILER V9.02   IS8U256A_UART                                                         12/11/2014 10:39:21 PAGE 2   

  55   1      
  56   1              return X;
  57   1      }
  58          
  59          /********************************************************************
  60           * Function Name        :UARTSetBaudRate
  61           * Description          :
  62           * Argument             :
  63           * Return               :
  64          *********************************************************************/
  65          static void UARTSetBaudRate(unsigned long baudrate)
  66          {
  67   1              unsigned long gcd;
  68   1              unsigned long baud_freq,baud_limit;
  69   1      
  70   1              gcd = GCD(UART_CLK,16*baudrate);
  71   1              baud_freq = (16*baudrate)/gcd;
  72   1              baud_limit = (UART_CLK/gcd)-baud_freq;
  73   1      
  74   1              BAUD_FREQ = (unsigned char)(baud_freq&0xFF);
  75   1              BAUD_FREQ = (unsigned char)((baud_freq>>8)&0xFF);
  76   1              BAUD_LIMIT = (unsigned char)(baud_limit&0xFF);
  77   1              BAUD_LIMIT = (unsigned char)((baud_limit>>8)&0xFF);
  78   1      }
  79          
  80          /********************************************************************
  81           * Function Name        :UARTInit
  82           * Description          :
  83           * Argument             :
  84           * Return               :
  85          *********************************************************************/
  86          void UARTInit(void)
  87          {
  88   1              /*使能PLL*/
  89   1              PLLCON |= 0x01;
  90   1      
  91   1              /*等待PLL稳定*/
  92   1              while(0x0==(PLLCON&0x02));
  93   1      
  94   1              /*使能GPIO模块*/
  95   1              PCON1 |= 0x08;
  96   1      
  97   1              /*GP11/12复用为UART引脚*/
  98   1              COMCON |= 0x40;
  99   1      
 100   1              /*使能UART模块*/
 101   1              PCON2 |= 0x04;
 102   1      
 103   1              /*选择UART寄存器组*/
 104   1              COMSEL = 0x01;
 105   1      
 106   1              /*设置波特率：115200*/
 107   1              UARTSetBaudRate(9600);
 108   1      
 109   1              /*设置接收停止位：1bit*/
 110   1              UARTPR &= 0x3F;
 111   1      
 112   1              /*设置接收数据宽度：8bit*/
 113   1              UARTPR &= 0xCF;
 114   1      
 115   1              /*设置发送停止位：1bit  */
 116   1              UARTPR &= 0xF3;
C51 COMPILER V9.02   IS8U256A_UART                                                         12/11/2014 10:39:21 PAGE 3   

 117   1      
 118   1              /*设置发送数据宽度：8bit */
 119   1              UARTPR &= 0xFC;
 120   1      
 121   1              /*使能接收偶校验*/
 122   1              UARTCON |= 0x10;
 123   1      
 124   1              /*使能发送偶校验*/
 125   1              UARTCON |= 0x04;
 126   1      
 127   1              /*使能UART中断模式*/
 128   1              UARTCON |= 0x01;
 129   1      
 130   1              /*使能UART中断*/
 131   1              IEH |= 0x20;
 132   1      
 133   1              /*使能总中断*/
 134   1              IEH |= 0x80;
 135   1      }
 136          /********************************************************************
 137           * Function Name        :UARTSendByte
 138           * Description          :
 139           * Argument             :
 140           * Return               :
 141          *********************************************************************/
 142          void UARTSendByte(unsigned char ch)
 143          {
 144   1              /*等待上次发送结束*/
 145   1              while(0x01&UARTSR);
 146   1      
 147   1              /*写入发送寄存器，启动本次发送*/
 148   1              TX_DATA = ch;
 149   1      
 150   1      }
 151          
 152          /********************************************************************
 153           * Function Name        :UARTHandler
 154           * Description          :
 155           * Argument             :
 156           * Return               :
 157          *********************************************************************/
 158          //void UARTHandler(void) interrupt 13
 159          //{
 160          //      unsigned char regtmp;
 161          //
 162          //      /*关闭总中断*/
 163          //      IEH &= 0x7F;    
 164          //
 165          //      /*处理接收中断*/
 166          //      if(UARTSTATUS&0x02)
 167          //      {
 168          //              /*清除接收中断标志*/
 169          //              UARTSTATUS &= 0xFD;
 170          //
 171          //              /*没有接收错误*/
 172          //              if(!(UARTSTATUS&0x38))
 173          //              {
 174          //                      /****************************************
 175          //                       * 
 176          //                       * 增加用户代码，
 177          //                       * 建议在此保存接收的数据，判断接收是否完
 178          //                       * 成，并置位相关标志，不对数据做具体处理
C51 COMPILER V9.02   IS8U256A_UART                                                         12/11/2014 10:39:21 PAGE 4   

 179          //                       *
 180          //                      *****************************************/
 181          //              }
 182          //              /*数据接收错误*/
 183          //              else
 184          //              {
 185          //                      /******************
 186          //                       * 
 187          //                       * 增加错误处理代码
 188          //                       *
 189          //                      *******************/
 190          //              }
 191          //      }
 192          //
 193          //      /*处理发送中断*/
 194          //      if(UARTSTATUS&0x04)
 195          //      {
 196          //              /*清除发送中断标志*/
 197          //              UARTSTATUS &= 0xFB;
 198          //
 199          //              /************************************
 200          //               * 
 201          //               * 增加用户代码，
 202          //               * 建议在此只清除标志位，不做其他处理
 203          //               *
 204          //              *************************************/
 205          //      }
 206          //
 207          //      /*恢复总中断*/
 208          //      IEH |= 0x80;
 209          //}
 210          
 211          /************************end of file*********************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    569    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      44
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
