C51 COMPILER V9.02   IS8U256A_SPISLAVE                                                     12/11/2014 10:38:41 PAGE 1   


C51 COMPILER V9.02, COMPILATION OF MODULE IS8U256A_SPISLAVE
OBJECT MODULE PLACED IN .\obj\IS8U256A_SPISlave.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE src\IS8U256A_SPISlave.c LARGE BROWSE DEBUG OBJECTEXTEND PRINT(.\lst\IS8U256
                    -A_SPISlave.lst) OBJECT(.\obj\IS8U256A_SPISlave.obj)

line level    source

   1          /*********************************************************************
   2          *               Copyright(C)2012北京华大信安科技有限公司
   3          *                       All Rights Reserved      
   4          *
   5          * 文件名称：    IS8U256A_SPISlave.c
   6          * 作    者：    李宪法
   7          * 版    本：    V1.0.0
   8          * 日    期：    2013-11
   9          * 功能描述：    
  10          * 功能列表：    
  11          *
  12          * 历史记录：
  13          * 1.  日期：    
  14          *         版本：
  15          *         作者：
  16          * 修改内容：
  17          *
  18          *********************************************************************/
  19          
  20          /*Includes----------------------------------------------------------*/
  21          #include "..\inc\IS8U256X.h"
  22          #include "..\inc\IS8U256A_GPIO.h"
  23          
  24          /*Private typedef---------------------------------------------------*/
  25          /*Private define----------------------------------------------------*/
  26                  /***********************************************
  27                   *根据具体情况，加载具体的指示信号
  28                   * **********************************************/
  29          #define TRANSMIT_RDY_FLAG               GPIO_PIN_20
  30          #define TransmitRdySet()                GPIOSet(TRANSMIT_RDY_FLAG)
  31          #define TransmitRdyReset()              GPIOReset(TRANSMIT_RDY_FLAG)
  32          
  33          /*Private macro-----------------------------------------------------*/
  34          /*Private variables-------------------------------------------------*/
  35          /*Private function prototypes---------------------------------------*/
  36          /*Private functions-------------------------------------------------*/
  37          
  38          /********************************************************************
  39           * Function Name        :SpiSlaveInit
  40           * Description          :
  41           * Argument             :
  42           * Return               :
  43          *********************************************************************/
  44          void SpiSlaveInit(void)
  45          {
  46   1              /*使能SPI模块*/
  47   1              PCON1 |= 0x10;
  48   1      
  49   1              /*GP7/8/9/10复用为SPI引脚*/
  50   1              COMCON |= 0x02;
  51   1      
  52   1              /*选择SPI寄存器组*/
  53   1              COMSEL = 0x0;
  54   1      
C51 COMPILER V9.02   IS8U256A_SPISLAVE                                                     12/11/2014 10:38:41 PAGE 2   

  55   1              /*SPI模式：单线模式*/
  56   1              SPIMODE &= 0xFC; 
  57   1      
  58   1              SPIMODE &= 0xDF;
  59   1      
  60   1              /*SPI模式：从模式*/
  61   1              SPICFG &= 0xFE;
  62   1      
  63   1              /*传输数据宽度为：8bit*/
  64   1              SPICFG |= 0x70;
  65   1      
  66   1              /*传输数据顺序为：MSB*/
  67   1              SPICFG |= 0x08;
  68   1      
  69   1              /*使能发送接收功能*/
  70   1              SPICON |= 0xC0;
  71   1      
  72   1              /*使能SPI控制器*/
  73   1              SPICON |= 0x01;
  74   1      }
  75          
  76          /********************************************************************
  77           * Function Name        :SpiTransmitData
  78           * Description          :
  79           * Argument             :
  80           * Return               :
  81          *********************************************************************/
  82          void SpiTransmitData(
  83                                  unsigned char xdata * ptxbuff,  \
  84                                  unsigned char xdata * prxbuff,  \
  85                                  unsigned char bytelen                   \
  86                                  )
  87          {
  88   1              unsigned char xdata regtmp;
  89   1              unsigned char xdata*ptxtmp=ptxbuff;
  90   1              unsigned char xdata*prxtmp=prxbuff;
  91   1              
  92   1              while(bytelen)
  93   1              {
  94   2                      if((void *)0!=ptxbuff)
  95   2                      {
  96   3                              /*写入传送数据*/
  97   3                              SPIDATA = *(ptxtmp++);
  98   3                      }
  99   2                      else
 100   2                      {
 101   3                              SPIDATA = 0x0;
 102   3                      }
 103   2      
 104   2                      /*设置RDY标志:低有效*/
 105   2                      TransmitRdySet();
 106   2      
 107   2                      /*清除RDY标志*/
 108   2                      TransmitRdyReset();
 109   2      
 110   2                      /*等待传送完成*/
 111   2                      while(0x0==(0x04&SPISTATUS));
 112   2      
 113   2                      regtmp = SPIDATA;
 114   2      
 115   2                      if((void *)0!=prxbuff)
 116   2                      {
C51 COMPILER V9.02   IS8U256A_SPISLAVE                                                     12/11/2014 10:38:41 PAGE 3   

 117   3                              /*读回传送结果*/
 118   3                              *(prxtmp++) = regtmp;
 119   3                      }
 120   2      
 121   2                      bytelen--;
 122   2      
 123   2              }
 124   1      
 125   1      }
 126          
 127          /***************************End of File*******************************/
 128          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    168    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
