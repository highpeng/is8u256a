#include <stdio.h> 
#include <openssl/bio.h> 
#include <openssl/engine.h> 
#include <openssl/rsa.h> 
#include <openssl/ssl.h>
#include <openssl/err.h>

BIO *bio_err = NULL;
BIO *bio_stdout = NULL;

unsigned char RSA2048_PlainText[256] =
{
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,
	0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11,0X11
};

unsigned char RSA2048_CipherText[256] =
{
	0x7f,0x4f,0xcb,0x6f,0x13,0xa0,0xf2,0x99,0xbc,0x62,0x1d,0xcd,0xd9,0x50,0x43,0xd6,
	0x62,0x83,0x93,0xc3,0x2b,0x1e,0x61,0x49,0x4f,0x4e,0xa6,0xda,0x1c,0x16,0xd9,0x20,
	0x68,0x9e,0x95,0x27,0x83,0x3f,0x62,0x3a,0x23,0x96,0xd2,0x0b,0x35,0x10,0x80,0xc5,
	0xc3,0x17,0xd0,0x26,0x3d,0xd2,0x46,0xe8,0xb2,0x7e,0x24,0xd1,0xa2,0x70,0x43,0xd4,
	0xfe,0x60,0x9f,0x7a,0x1c,0xd4,0x34,0xc9,0xd3,0x0c,0x0f,0xe7,0x01,0xa8,0x29,0x85,
	0xd5,0x4d,0xf1,0xfe,0x82,0xb5,0x30,0x37,0x69,0xfe,0x91,0x93,0x37,0x51,0x07,0xf3,
	0xbe,0x82,0xb1,0xc9,0xde,0xd5,0x45,0x9b,0xe5,0xee,0xda,0xd2,0xd1,0xad,0x05,0xc9,
	0x53,0x97,0x42,0xc4,0xb0,0x73,0xf5,0x42,0x4c,0x05,0x57,0x7d,0xda,0xf1,0x46,0x33,
	0x06,0x15,0x38,0x4f,0x69,0xae,0x1a,0x4e,0x4d,0x6d,0xa2,0x1d,0x13,0xd8,0x9d,0x3b,
	0x90,0x1a,0x80,0x48,0xca,0x3c,0x8a,0x6c,0x6e,0x52,0x04,0x0b,0x26,0xda,0x4e,0x69,
	0x5c,0xa2,0x81,0xe7,0xce,0xd3,0xb3,0x90,0xd7,0xe7,0x2c,0x1f,0x1d,0x79,0xbc,0xb5,
	0x7b,0x30,0x67,0x08,0x72,0x17,0xdb,0x9b,0xe6,0x7f,0x51,0x19,0x31,0xff,0x63,0x60,
	0xb7,0x19,0xe0,0x44,0xdd,0xb1,0xc3,0xaf,0x43,0x03,0x65,0xaf,0x34,0x8b,0xa5,0x68,
	0x84,0x4b,0xa8,0x99,0x8e,0xcc,0xdb,0xdb,0x68,0x39,0x22,0x16,0x5d,0x9b,0xca,0x00,
	0x1c,0x6c,0x8d,0xf0,0x6a,0x6f,0x83,0xd2,0x9e,0xd9,0x7a,0xcc,0xfa,0x2a,0x51,0xd3,
	0x12,0x7d,0xa7,0x19,0x9d,0xb0,0x85,0xae,0xc2,0x1b,0x2c,0xf1,0x68,0xcf,0xdd,0x16
};

/* Try to load an engine in a shareable library */
static ENGINE *try_load_engine(BIO *err, const char *engine)
{
	ENGINE *e = ENGINE_by_id("dynamic");
	if (e) {
		if (!ENGINE_ctrl_cmd_string(e, "SO_PATH", engine, 0)
				|| !ENGINE_ctrl_cmd_string(e, "LOAD", NULL, 0)) {
			ENGINE_free(e);
			e = NULL;
		}
	}
	return e;
}

ENGINE *setup_engine(BIO *err, const char *engine)
{
	ENGINE *e = NULL;

	ENGINE_load_builtin_engines();

	if (engine) {
		if ((e = ENGINE_by_id(engine)) == NULL
				&& (e = try_load_engine(err, engine)) == NULL) {
			BIO_printf(err, "invalid engine \"%s\"\n", engine);
			ERR_print_errors(err);
			return NULL;
		}
		if(!ENGINE_init(e)) {
		/* the engine couldn't initialise, release 'e' */
		ENGINE_free(e);
		return NULL;
		}
		if (!ENGINE_set_default(e, ENGINE_METHOD_RSA)) {
		BIO_printf(err, "can't use that engine\n");
		ERR_print_errors(err);
		ENGINE_free(e);
		return NULL;
		}

		BIO_printf(err, "engine \"%s\" set.\n", ENGINE_get_id(e));
		ENGINE_finish(e);
		/* Free our "structural" reference. */
		ENGINE_free(e);
	}

	return e;
}

int main(int argc, char *argv[])
{
	unsigned char *buf;
//	unsigned char bufin[256]={0};
	const char *engine = "rsa";
	RSA *p_rsa=RSA_new();
	ENGINE *e = NULL;
	
	bio_err = BIO_new_fp(stderr, BIO_NOCLOSE | BIO_FP_TEXT);
	bio_stdout = BIO_new_fp(stdout, BIO_NOCLOSE | BIO_FP_TEXT);

	setup_engine(bio_err, engine);
	/**/
	//for testing
	/**/
	printf("\nmain test ssh\n");
	e = ENGINE_by_id(engine);
	printf("engine id :%s,name:%s\n",ENGINE_get_id(e),ENGINE_get_name(e));
	p_rsa->meth = ENGINE_get_RSA(e);

	RSA_public_encrypt(256,RSA2048_PlainText,buf,p_rsa,RSA_PKCS1_OAEP_PADDING);
	if(memcmp(buf,RSA2048_CipherText,256)!=0)
		printf("ERR:Encrypt failed  !!!\n");

	RSA_free(p_rsa);
	if (bio_err != NULL)
		BIO_free(bio_err);

	return 0;
}

